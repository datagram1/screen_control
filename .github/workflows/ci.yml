name: CI Pipeline

# This is a lightweight CI pipeline for code validation only
# All platform builds are done locally on self-hosted infrastructure
# This saves GitHub Actions costs (macOS/Windows runners are expensive)

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'claude/**'
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  # ============================================
  # Code Validation
  # ============================================
  validate:
    name: Validate Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for merge conflicts
        run: |
          if grep -rn "<<<<<<< HEAD" --include="*.cpp" --include="*.h" --include="*.m" --include="*.swift" --include="*.cs" --include="*.ts" --include="*.tsx" . 2>/dev/null | grep -v node_modules; then
            echo "Merge conflict markers found!"
            exit 1
          fi
          echo "No merge conflicts found"

      - name: Check for debug statements
        run: |
          echo "Checking for common debug statements that should be removed..."
          # Just warn, don't fail
          grep -rn "console\.log\|debugger\|TODO:" --include="*.ts" --include="*.tsx" . 2>/dev/null | grep -v node_modules | head -10 || true

      - name: Validate version.json
        run: |
          if [ -f "version.json" ]; then
            python3 -m json.tool version.json > /dev/null && echo "version.json is valid" || exit 1
          fi

  # ============================================
  # Security Scan
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential hardcoded secrets..."
          # Look for common patterns that might indicate secrets
          PATTERNS=(
            'password\s*=\s*["\x27][^"\x27]+'
            'api[_-]?key\s*=\s*["\x27][^"\x27]+'
            'secret\s*=\s*["\x27][^"\x27]+'
            'token\s*=\s*["\x27][^"\x27]+'
          )
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -riE "$pattern" --include="*.cpp" --include="*.h" --include="*.cs" --include="*.ts" . 2>/dev/null | grep -v node_modules | grep -v "example" | grep -v "placeholder" | head -3; then
              FOUND=1
            fi
          done
          if [ $FOUND -eq 1 ]; then
            echo "Warning: Potential secrets found. Please review."
          else
            echo "No obvious hardcoded secrets found"
          fi

      - name: Check .env files not committed
        run: |
          if find . -name ".env" -not -path "./node_modules/*" | grep -q .; then
            echo "Warning: .env file(s) found in repository!"
            find . -name ".env" -not -path "./node_modules/*"
          else
            echo "No .env files committed"
          fi

  # ============================================
  # Status Summary
  # ============================================
  status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [validate, security]
    if: always()

    steps:
      - name: Check results
        run: |
          if [ "${{ needs.validate.result }}" != "success" ]; then
            echo "Validation failed"
            exit 1
          fi
          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "Security scan failed"
            exit 1
          fi
          echo "All CI checks passed!"
          echo ""
          echo "Note: Platform builds (macOS, Windows, Linux) are done locally."
          echo "This pipeline only validates code quality and security."
