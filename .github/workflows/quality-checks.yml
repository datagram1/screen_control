name: Quality Checks

# This workflow runs quality checks only - builds are done locally
# Platform builds have been removed to reduce GitHub Actions costs
# and because builds are now done on local self-hosted infrastructure

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ============================================
  # Code Quality Checks
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for sensitive data
      run: |
        echo "Checking for potential sensitive data..."
        SENSITIVE_PATTERNS=("api[_-]?key\s*=" "password\s*=" "secret\s*=" "private[_-]?key")
        FOUND=0
        for pattern in "${SENSITIVE_PATTERNS[@]}"; do
          if grep -r -i -E "$pattern" --include="*.cpp" --include="*.h" --include="*.m" --include="*.swift" --include="*.cs" . 2>/dev/null | grep -v "node_modules" | grep -v ".git" | grep -v "// example" | head -5; then
            echo "Warning: Potential sensitive data found with pattern: $pattern"
            FOUND=1
          fi
        done
        if [ $FOUND -eq 0 ]; then
          echo "No obvious sensitive data patterns found"
        fi

    - name: Check file permissions
      run: |
        echo "Checking build scripts are executable..."
        if [ -f "build-all.sh" ]; then
          if [ -x "build-all.sh" ]; then
            echo "build-all.sh is executable"
          else
            echo "Warning: build-all.sh is not executable"
          fi
        fi

    - name: Check for large files
      run: |
        echo "Checking for large files (>10MB)..."
        find . -type f -size +10M -not -path "./.git/*" -not -path "./node_modules/*" -not -path "*/node_modules/*" 2>/dev/null | head -10 || echo "No large files found"

  # ============================================
  # Documentation Check
  # ============================================
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check README exists
      run: |
        if [ -f "README.md" ]; then
          echo "README.md exists"
        else
          echo "README.md not found"
          exit 1
        fi

    - name: Check essential docs
      run: |
        echo "Checking documentation..."
        for doc in "service/docs" "macos/ScreenControl"; do
          if [ -d "$doc" ] || [ -f "$doc" ]; then
            echo "$doc exists"
          else
            echo "$doc not found (optional)"
          fi
        done

  # ============================================
  # Syntax Validation
  # ============================================
  syntax-check:
    name: Syntax Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate JSON files
      run: |
        echo "Validating JSON files..."
        find . -name "*.json" -not -path "./node_modules/*" -not -path "*/node_modules/*" -not -path "./.git/*" | while read file; do
          if python3 -m json.tool "$file" > /dev/null 2>&1; then
            echo "Valid: $file"
          else
            echo "Invalid JSON: $file"
          fi
        done | grep -c "Invalid" && exit 1 || true

    - name: Validate YAML files
      run: |
        echo "Validating YAML workflow files..."
        for file in .github/workflows/*.yml .github/workflows/*.yaml; do
          if [ -f "$file" ]; then
            if python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
              echo "Valid: $file"
            else
              echo "Invalid YAML: $file"
            fi
          fi
        done
